@model HasatEmlak.Models.ViewModels.PropertyListViewModel

@{
    ViewData["Title"] = "İlan Listesi";
}

<!-- Page Header -->
<div class="bg-light py-5">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h2 mb-2">Emlak İlanları</h1>
                <p class="text-muted mb-0">
                    Toplam <strong>@Model.TotalCount</strong> ilan bulundu
                </p>
            </div>
            <div class="col-md-4 text-end">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb justify-content-md-end mb-0">
                        <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Ana Sayfa</a></li>
                        <li class="breadcrumb-item active">İlanlar</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</div>

<div class="container py-4">
    <div class="row">
        <!-- Filter Sidebar -->
        <div class="col-lg-3 mb-4">
            <div class="card shadow-sm sticky-top">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtreler</h5>
                </div>
                <div class="card-body">
                    <form asp-action="Index" method="get">
                        <!-- Kategori -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Kategori</label>
                            <select class="form-select" name="categoryId" asp-for="SearchModel.CategoryId">
                                <option value="">Tümü</option>
                                @foreach (var category in ViewBag.Categories as IEnumerable<HasatEmlak.Models.Entities.Category>)
                                {
                                    <option value="@category.Id">@category.Name</option>
                                }
                            </select>
                        </div>

                        <!-- Emlak Türü -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Emlak Türü</label>
                            <select class="form-select" name="propertyTypeId" asp-for="SearchModel.PropertyTypeId">
                                <option value="">Tümü</option>
                                @foreach (var type in ViewBag.PropertyTypes as IEnumerable<HasatEmlak.Models.Entities.PropertyType>)
                                {
                                    <option value="@type.Id">@type.Name</option>
                                }
                            </select>
                        </div>

                        <!-- Şehir -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Şehir</label>
                            <select class="form-select" name="cityId" id="citySelect" asp-for="SearchModel.CityId">
                                <option value="">Tümü</option>
                                @foreach (var city in ViewBag.Cities as IEnumerable<HasatEmlak.Models.Entities.City>)
                                {
                                    <option value="@city.Id">@city.Name</option>
                                }
                            </select>
                        </div>

                        <!-- İlçe -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">İlçe</label>
                            <select class="form-select" name="districtId" id="districtSelect" asp-for="SearchModel.DistrictId">
                                <option value="">İlçe Seçin</option>
                            </select>
                        </div>

                        <!-- Fiyat Aralığı -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Fiyat Aralığı (₺)</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="number" class="form-control" name="minPrice"
                                           placeholder="En Az" asp-for="SearchModel.MinPrice">
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control" name="maxPrice"
                                           placeholder="En Çok" asp-for="SearchModel.MaxPrice">
                                </div>
                            </div>
                        </div>

                        <!-- Alan -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Alan (m²)</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="number" class="form-control" name="minArea"
                                           placeholder="En Az" asp-for="SearchModel.MinArea">
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control" name="maxArea"
                                           placeholder="En Çok" asp-for="SearchModel.MaxArea">
                                </div>
                            </div>
                        </div>

                        <!-- Oda Sayısı -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Oda Sayısı</label>
                            <select class="form-select" name="roomCount" asp-for="SearchModel.RoomCount">
                                <option value="">Farketmez</option>
                                <option value="1">1+0</option>
                                <option value="2">1+1</option>
                                <option value="3">2+1</option>
                                <option value="4">3+1</option>
                                <option value="5">4+1</option>
                                <option value="6">5+1 ve üzeri</option>
                            </select>
                        </div>

                        <!-- Arama Kelimesi -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Arama</label>
                            <input type="text" class="form-control" name="keywords"
                                   placeholder="Başlık, açıklama..." asp-for="SearchModel.Keywords">
                        </div>

                        <!-- Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search me-1"></i>Filtrele
                            </button>
                            <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                                <i class="fas fa-undo me-1"></i>Temizle
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Properties List -->
        <div class="col-lg-9">
            <!-- Sort & View Options -->
            <div class="row align-items-center mb-4">
                <div class="col-md-6">
                    <p class="text-muted mb-0">
                        <strong>@((Model.CurrentPage - 1) * 12 + 1)</strong> -
                        <strong>@Math.Min(Model.CurrentPage * 12, Model.TotalCount)</strong> /
                        <strong>@Model.TotalCount</strong> ilan gösteriliyor
                    </p>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-md-end align-items-center gap-2">
                        <label class="form-label mb-0 me-2">Sırala:</label>
                        <select class="form-select w-auto" id="sortSelect">
                            <option value="date_desc" selected>Tarihe Göre (Yeni)</option>
                            <option value="date_asc">Tarihe Göre (Eski)</option>
                            <option value="price_asc">Fiyata Göre (Düşük)</option>
                            <option value="price_desc">Fiyata Göre (Yüksek)</option>
                            <option value="area_desc">Alana Göre (Büyük)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Properties Grid -->
            @if (Model.Properties != null && Model.Properties.Any())
            {
                <div class="row" id="propertiesContainer">
                    @foreach (var property in Model.Properties)
                    {
                        <div class="col-lg-6 col-xl-4 mb-4" data-aos="fade-up" data-aos-delay="@(Model.Properties.ToList().IndexOf(property) * 50)">
                            <div class="card property-card h-100">
                                <div class="position-relative">
                                    @if (property.PropertyImages != null && property.PropertyImages.Any())
                                    {
                                        <img src="/@property.PropertyImages.FirstOrDefault()?.ImagePath" class="card-img-top" alt="@property.Title" />
                                    }
                                    else
                                    {
                                        <img src="https://via.placeholder.com/400x250?text=Görsel+Yok" class="card-img-top" alt="@property.Title" />
                                    }

                                    <span class="badge bg-@(property.CategoryId == 1 ? "success" : "primary")">
                                        @property.Category?.Name
                                    </span>
                                    <button class="btn favorite-btn" title="Favorilere Ekle">
                                        <i class="far fa-heart"></i>
                                    </button>
                                </div>

                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">@property.Title</h5>
                                    <p class="card-text text-muted small mb-2">
                                        <i class="fas fa-map-marker-alt me-1"></i>
                                        @property.District?.Name, @property.City?.Name
                                    </p>

                                    <div class="property-features mb-3">
                                        @if (property.Area.HasValue)
                                        {
                                            <span><i class="fas fa-expand-arrows-alt"></i> @property.Area m²</span>
                                        }
                                        @if (property.RoomCount.HasValue)
                                        {
                                            <span><i class="fas fa-bed"></i> @property.RoomCount oda</span>
                                        }
                                        @if (property.BathroomCount.HasValue)
                                        {
                                            <span><i class="fas fa-bath"></i> @property.BathroomCount banyo</span>
                                        }
                                    </div>

                                    <div class="mt-auto">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="property-price">@property.Price.ToString("N0") ₺</div>
                                            <a href="@Url.Action("Details", "Property", new { id = property.Id })" class="btn btn-primary btn-sm">
                                                Detay <i class="fas fa-arrow-right ms-1"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- Pagination -->
                @if (Model.TotalPages > 1)
                {
                    <nav aria-label="Property pagination" class="mt-4">
                        <ul class="pagination justify-content-center">
                            @if (Model.HasPreviousPage)
                            {
                                <li class="page-item">
                                    <a class="page-link" href="@Url.Action("Index", new { page = Model.CurrentPage - 1, categoryId = Model.SearchModel.CategoryId, propertyTypeId = Model.SearchModel.PropertyTypeId, cityId = Model.SearchModel.CityId, districtId = Model.SearchModel.DistrictId, minPrice = Model.SearchModel.MinPrice, maxPrice = Model.SearchModel.MaxPrice, minArea = Model.SearchModel.MinArea, maxArea = Model.SearchModel.MaxArea, roomCount = Model.SearchModel.RoomCount, keywords = Model.SearchModel.Keywords })">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                </li>
                            }

                            @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                            {
                                <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                    <a class="page-link" href="@Url.Action("Index", new { page = i, categoryId = Model.SearchModel.CategoryId, propertyTypeId = Model.SearchModel.PropertyTypeId, cityId = Model.SearchModel.CityId, districtId = Model.SearchModel.DistrictId, minPrice = Model.SearchModel.MinPrice, maxPrice = Model.SearchModel.MaxPrice, minArea = Model.SearchModel.MinArea, maxArea = Model.SearchModel.MaxArea, roomCount = Model.SearchModel.RoomCount, keywords = Model.SearchModel.Keywords })">
                                        @i
                                    </a>
                                </li>
                            }

                            @if (Model.HasNextPage)
                            {
                                <li class="page-item">
                                    <a class="page-link" href="@Url.Action("Index", new { page = Model.CurrentPage + 1, categoryId = Model.SearchModel.CategoryId, propertyTypeId = Model.SearchModel.PropertyTypeId, cityId = Model.SearchModel.CityId, districtId = Model.SearchModel.DistrictId, minPrice = Model.SearchModel.MinPrice, maxPrice = Model.SearchModel.MaxPrice, minArea = Model.SearchModel.MinArea, maxArea = Model.SearchModel.MaxArea, roomCount = Model.SearchModel.RoomCount, keywords = Model.SearchModel.Keywords })">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                            }
                        </ul>
                    </nav>
                }
            }
            else
            {
                <!-- No Results -->
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-search fa-4x text-muted"></i>
                    </div>
                    <h4>İlan Bulunamadı</h4>
                    <p class="text-muted mb-4">Arama kriterlerinize uygun ilan bulunmamaktadır.</p>
                    <a href="@Url.Action("Index")" class="btn btn-primary">
                        <i class="fas fa-undo me-1"></i>Tüm İlanları Görüntüle
                    </a>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // City/District AJAX
            $('#citySelect').change(function() {
                var cityId = $(this).val();
                var districtSelect = $('#districtSelect');

                districtSelect.html('<option value="">Yükleniyor...</option>');

                if (cityId) {
                    $.get('@Url.Action("GetDistricts", "Property")', { cityId: cityId }, function(data) {
                        var options = '<option value="">İlçe Seçin</option>';
                        $.each(data, function(index, district) {
                            options += '<option value="' + district.id + '">' + district.name + '</option>';
                        });
                        districtSelect.html(options);
                    });
                } else {
                    districtSelect.html('<option value="">İlçe Seçin</option>');
                }
            });

            // Sort functionality
            $('#sortSelect').change(function() {
                var currentUrl = new URL(window.location);
                currentUrl.searchParams.set('sortBy', $(this).val());
                currentUrl.searchParams.delete('page'); // Reset to first page
                window.location.href = currentUrl.toString();
            });

            // Set sort value from URL
            var urlParams = new URLSearchParams(window.location.search);
            var sortBy = urlParams.get('sortBy') || 'date_desc';
            $('#sortSelect').val(sortBy);

            // Load districts if city is selected
            var selectedCityId = $('#citySelect').val();
            var selectedDistrictId = '@Model.SearchModel?.DistrictId';

            if (selectedCityId) {
                $.get('@Url.Action("GetDistricts", "Property")', { cityId: selectedCityId }, function(data) {
                    var options = '<option value="">İlçe Seçin</option>';
                    $.each(data, function(index, district) {
                        var selected = district.id == selectedDistrictId ? 'selected' : '';
                        options += '<option value="' + district.id + '" ' + selected + '>' + district.name + '</option>';
                    });
                    $('#districtSelect').html(options);
                });
            }

            // Favorite button functionality
            $('.favorite-btn').click(function(e) {
                e.preventDefault();
                var icon = $(this).find('i');
                if (icon.hasClass('far')) {
                    icon.removeClass('far').addClass('fas');
                    $(this).addClass('text-danger');
                    // TODO: Add to favorites
                } else {
                    icon.removeClass('fas').addClass('far');
                    $(this).removeClass('text-danger');
                    // TODO: Remove from favorites
                }
            });
        });
    </script>
}